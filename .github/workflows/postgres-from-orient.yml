name: Create a postgre database from an oriendb dump

on:
  workflow_call:
    inputs:
      application-name:
        required: true
        type: string
      addon-plan-postgresql:
        required: true
        type: string
      extensions:
        required: false
        type: string
        default: ''
      scalingo-remote-domain-url:
        required: false
        type: string
        default: "git@ssh.osc-fr1.scalingo.com"
      scalingo-ssh-host-domain:
        required: false
        type: string
        default: "ssh.osc-fr1.scalingo.com"

    secrets:
      SCALINGO_API_TOKEN:
        required: true
      DUMP_FILENAME:
      ORIENTDB_DBLOGIN:
        required: true
      ORIENTDB_DBNAME:
        required: true
      ORIENTDB_DBPASSWORD:
        required: true
      SSH_ZORA_LOGIN:
        required: true
      SSH_ZORA_PASSWORD:
        required: true
      ZORA_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      HOST:
        required: true
      PORT:
        required: true
      FINGERPRINT:
        required: true

jobs:
  migrate:
    name: Create drivers from json
    needs: wait-addon-running
    runs-on: ubuntu-latest
    steps:
      steps:
        - name: Generate dump on legacy server
          uses: appleboy/ssh-action@v0.1.7
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.ZORA_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            passphrase: ${{ secrets.SSH_ZORA_PASSWORD }}
            port: ${{ secrets.PORT }}
            script: |
              cd /opt
              sudo /opt/orientdb-community-2.2.30/bin/console.sh "connect plocal:orientdb-community-2.2.30/databases/${{ secrets.ORIENTDB_DBNAME }} ${{ secrets.ORIENTDB_DBLOGIN }} ${{ secrets.ORIENTDB_DBPASSWORD }};EXPORT DATABASE /home/${{ secrets.ZORA_USER }}/${{ secrets.DUMP_FILENAME }};exit"
              cd /home/${{ secrets.ZORA_USER }}
              sudo chown ${{ secrets.ZORA_USER }}:${{ secrets.ZORA_USER }} ${{ secrets.DUMP_FILENAME }}
              ls -la
              exit

        - name: Copy dump to runner
          uses: nicklasfrahm/scp-action@main
          with:
            direction: download
            host: ${{ secrets.HOST }}
            username: ${{ secrets.ZORA_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            passphrase: ${{ secrets.SSH_ZORA_PASSWORD }}
            fingerprint: ${{ secrets.FINGERPRINT }}
            port: ${{ secrets.PORT }}
            source: "/home/${{ secrets.ZORA_USER }}/${{ secrets.DUMP_FILENAME }}"
            target: "${{ secrets.DUMP_FILENAME }}"

        - name: Get file from repo
          uses: actions/checkout@v3

        - name: Check file
          run: |
            ls -la




